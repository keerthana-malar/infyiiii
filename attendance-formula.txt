name = createdBy.name;

$checkin_d = datetime\today();
$checkin_t = "09:45:00";
$checkin_dt = string\concatenate($checkin_d," ", $checkin_t);


$checkout_t = "19:00:00";
$checkout_dt = string\concatenate($checkin_d," ", $checkout_t);

$current_dt = datetime\now();

$wd = createdBy.workingdays + 1; 
$lt = createdBy.leavetaken;
$pt = createdBy.permissiontaken;
$ot = createdBy.overtime;
$la = createdBy.latetime;
$ad = createdBy.advance;
$ex = createdBy.expense;
$sa = createdBy.salary;
$in = createdBy.incentive;

$mo = datetime\format($current_dt, 'Asia/Kolkata', 'MM' );

$yr = datetime\format($current_dt, 'Asia/Kolkata', 'YYYY');

$per_id = array\at(createdBy.empMpsIds, 0);

ifThenElse(
    attendancetype == "checkin",
    checkintime = $current_dt;
    record\update('User', createdById , 'workingdays' , $wd);
    record\update('User', createdById , 'yearlyworkingdays' , createdBy.yearlyworkingdays + 1);
    ifThenElse(
    $wd <= "1" && $lt == "0",
    record\create('EmpMp',
        'name', name,
        'userId', createdById,
        'month', $mo,
        'year', $yr,
        'workingdays', $wd,
        'leaveTaken', $lt,
        'permissionTime', $pt,
        'overTime', $ot,
        'lateTime', $la,
        'advance', $ad,
        'expense', $ex,
        'salary', $sa,
        'incentive', $in
    ),
    record\update('EmpMp', $per_id, 
        'workingdays', $wd,
        'leaveTaken', $lt,
        'permissionTime', $pt,
        'overTime', $ot,
        'lateTime', $la,
        'advance', $ad,
        'expense', $ex,
        'salary', $sa,
        'incentive', $in
    )
    ),
    checkouttime = $current_dt
    );
    
$late_time = datetime\diff(checkintime , $checkin_dt , "minutes") + 330;

ifThen(
    $late_time > 0 && attendancetype == 'checkin',
    late = string\concatenate($late_time ," minutes Late");
    record\update('User', createdById , 'latetime', createdBy.latetime + $late_time);
    record\update('User', createdById , 'latetimeyearly', createdBy.latetimeyearly + $late_time)
);

$overtime = datetime\diff(checkouttime , $checkout_dt , 'minutes')  + 330;

ifThen(
    $overtime > 0 && attendancetype == 'checkout',
    overtime = string\concatenate($overtime," minutes overtime");
    record\update('User', createdById , 'overtime', createdBy.overtime + $overtime);
    record\update('User', createdById , 'overtimeyearly', createdBy.overtimeyearly + $overtime)
);

//Map

ifThen(
    workingfrom == "office", 
    locationStreet = "hari Complex";
    locationCity = "Coimbatore";
    locationState = "Tamilnadu";
    locationPostalCode = 641035;
    );
    
ifThen(
    workingfrom == "outside", 
    locationStreet = account.billingAddressStreet;
    locationCity = account.billingAddressCity;
    locationCountry = account.billingAddressCountry
    locationPostalCode = account.billingAddressPostalCode;
    locationState = account.billingAddressState;
    ); 
    
    
ifThen(
    $mo == 01 && $lt == "0" && $wd <= "1",
    record\create('EmpYp',
        'name', name,
        'userId', createdById,
        'month', $mo,
        'year', $yr,
        'workingdays', $wd,
        'leaveTaken', $lt,
        'permissionTime', $pt,
        'overTime', $ot,
        'lateTime', $la,
        'advance', $ad,
        'expense', $ex,
        'salary', $sa,
        'incentive', $in
    ),
    record\update('EmpYp', $per_id, 
        'workingdays', $wd,
        'leaveTaken', $lt,
        'permissionTime', $pt,
        'overTime', $ot,
        'lateTime', $la,
        'advance', $ad,
        'expense', $ex,
        'salary', $sa,
        'incentive', $in
    )
);
